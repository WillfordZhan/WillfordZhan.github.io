---
title: "Dify 还是自研 RAG：铸造 MES/ERP 场景的架构共创与落地计划"
date: 2026-02-20 23:34:33
categories:
  - "AI"
tags:
  - "AI工作日志"
  - "AI工程"
  - "RAG"
  - "Dify"
  - "MCP"
  - "架构设计"
  - "知识库"
---

## 背景

这轮讨论的目标非常明确：在已经完成一轮 Python AI 控制面重构的基础上，快速集成铸造行业知识库能力，兼顾两件事：

1. 先做出可上线、可用的生产能力。
2. 方案本身要有工程亮点，能成为 AI 工程师岗位面试中的核心项目叙事。

场景约束也很典型：数据来源复杂（公众号、书籍、工艺参数文档、行业文档），知识密度高、噪声高，且业务同时涉及 MES 实时数据与行业知识问答。

## 先给结论

这类场景不建议纯二选一（只用 Dify 内置 KB，或一上来全自研）。

推荐路线是：

1. **双线并行**：Dify 与自研检索服务同时接入。
2. **能力分层**：
   - Dify 负责快速编排和业务流程试错。
   - 自研 RAG 检索服务负责数据清洗、切分、召回、重排、评测等“效果上限”能力。
3. **Agent 策略收敛**：
   - 在线默认 `ReAct + 工具调用 + RAG`。
   - `Plan-and-solve` 仅在复杂任务触发。
   - `Reflection` 只在低置信度/高风险场景触发，不全量开启。

一句话总结：**用 Dify 赢速度，用自研检索赢上限。**

## 为什么不是纯 Dify 或纯自研

### 纯 Dify 内置知识库

优点：上线最快。  
短板：在高噪声行业语料中，后期检索质量和可控性容易触顶。

### 纯自研全栈 RAG

优点：长期上限高，可控性强。  
短板：首期周期长，工程和运维复杂度高，不符合“快出效果”目标。

### 混合方案（推荐）

优点：首期快，长期可控，风险最低。  
短板：需要做好契约治理和双链路观测，但这是可工程化解决的问题。

## 我们讨论沉淀的 10 条 Q&A（决策版）

### Q1：数据合规先不管，能不能先做？
可以先做验证版，但建议保留文档来源和版本元数据，后续补治理时不会返工。

### Q2：如果增强效果需要上新基础设施，可以加吗？
可以。建议优先上支持混合检索的引擎（如 OpenSearch）。

### Q3：数据量 <= 20G，QPS 50~500，怎么设计？
这个规模下，核心不在“能不能跑”，而在“高峰稳定和检索质量可回归”。需要缓存、分级策略和压测门禁。

### Q4：先用 Qwen 最强模型验证效果，后续再谈成本，是否可行？
可行，且是正确顺序。先做质量上限验证，再做成本优化和模型分层。

### Q5：Reranker 私有部署和公有部署区别？
公有部署：上线快、质量通常更好、免运维，但有调用成本和外部延迟。  
私有部署：数据与服务更可控，但你当前 `4核8G + 无GPU` 条件下吞吐会受限。  
建议：**先公有验证，后私有评估**。

### Q6：ACL 是什么？
ACL（Access Control List）是访问控制列表。  
在 RAG 里就是“谁能检索到哪些文档/片段”的硬约束，必须在召回阶段就生效。

### Q7：数据更新要分钟级，能支持吗？
能。需要增量 ingest + upsert 索引 + 任务队列，避免全量重建。

### Q8：Dify 和自研双接入是否推荐？
推荐。这正是当前阶段“快 + 稳 + 可扩展”的最优策略。

### Q9：什么是金标问答？为什么必须做？
金标问答不是 few-shot，它是评测基准集。  
作用是客观评估“改了检索策略后是否真的变好”，避免调参靠感觉。

示例（非行业）：

```json
{
  "id": "qa_001",
  "question": "锅炉水质硬度超标会导致什么问题？",
  "answerable": true,
  "expected_doc_ids": ["doc_chem_12", "doc_ops_03"],
  "must_include_points": ["结垢风险", "换热效率下降", "能耗上升"]
}
```

### Q10：低置信时策略怎么定？
采用“**追问 + 带风险提示回答**”。这是兼顾可用性与安全性的合理策略。

## 生产落地建议（阶段化）

### Phase 1：2~3 周，先跑通效果

1. 建立最小 ingest pipeline（解析/清洗/切分/元数据）。
2. 上线 `Hybrid Retrieval`（关键词 + 向量）与基础过滤。
3. 输出可引用证据（chunk/doc 引用 ID）。

### Phase 2：3~5 周，提升稳定性

1. 加 reranker（按复杂度和置信度触发）。
2. 建立分钟级增量更新链路。
3. 建立缓存与限流，控制峰值时延。

### Phase 3：5~8 周，工程化闭环

1. 建立金标问答集和离线评测流水线。
2. 对接 Dify External Knowledge API 与 Python Agent 双入口。
3. 做回归门禁（Recall@K、citation 覆盖率、低置信策略命中率、P95 时延）。

## 面试亮点怎么讲

这套项目建议按下面这条主线讲：

1. 我没有做“玩具 Agent”，而是做了“可运营 RAG 平台化能力”。
2. 架构上用双通道解耦了“业务实时数据工具调用”和“行业知识检索问答”。
3. 通过金标评测和回归门禁，把模型调优从“经验主义”变成“工程可验证”。
4. 在资源受限（无 GPU）条件下，通过分级策略、缓存和路由，实现了效果与成本平衡。

## 最后一句

在铸造 MES/ERP 场景，真正决定成败的不是“Agent 名字有多花”，而是：

1. 数据管道质量。
2. 检索与过滤设计。
3. 评测和回归体系。

先把这三件事做好，RAG 才会从 Demo 变成生产能力。
